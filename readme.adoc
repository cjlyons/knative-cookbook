= Play around with kubernetes
* Based on RedHat tutorials @ https://redhat-developer-demos.github.io/knative-tutorial

== Development Tools for Windows 10
|===
|Tool |Version |Use

|cygwin
|3.1.7
|Linux commands for windows

|git
|2.17.0
|Source code management

|kubectl
|1.19.0
|k8s CLI

|helm
|3.3.4
|Help define, install, & upgrade k8s apps

|stern
|1.11.0
|tail multiple pods and containers within each pod

|yq
|3.4.0
|Command line YAML processor. choco install yq

|httpie
|2.2.0
|HTTP command line tool

|hey
|N/A, build from https://github.com/rakyll/hey
|load generator

|watch
|watch from procps-ng 3.3.12
|execute a program periodically

|kubectx
|N/A, download bin from https://github.com/thomasliddledba/kubectxwin
|Switch between k8s clusters and namespaces

|kubens
|N/A, download bin from https://github.com/thomasliddledba/kubenswin
|kubectx dependency

|minikube
|1.13.1
|one node k8s cluster for local development

|kubernetes
|1.19.2
|installed with minikube

|docker
|19.03.13, build 4484c46d9d
|run containers

|minikube registry
|minikube -p knativecookbook addons enable registry
|container registry on port 32773

|Istio
|1.4.10, installed using ./bin/install-istio.sh
|ingress gateway (only using the ingress component of Istio at this point)

|Knative
|Serving:0.12.0 Eventing:0.12.0
|The "serving" component provides simplified deployment syntax and automated scale up and down (to 0). 
The "eventing" component connects Knative Serving Services to event streams other than HTTP (e.g. kafka)

|Java
|11.0.8
|Develop the spring boot version of greeter  

|Node.js
|12.18.4
|Develop the Node version of greeter 
|===

== knative setup

=== setup steps
. Setup from scratch
.. setup.bat contains the steps I used to set up knative in order to run through the RedHat tutorials.
I scripted this as I kept getting my minikube cluster in a bad state while hacking around for various projects.
This script now resets everything from scratch and gets me back to a point where I can run through the tutorials again.
. Minimal steps needed every time we restart
.. setup minikube hosts file
... cd ..\apps\minikube-registry-helper
... kubectl apply -n kube-system -f registry-aliases-config.yaml
... kubectl apply -n kube-system -f node-etc-hosts-update.yaml
... bash patch-coredns.sh
... @FOR /f "tokens=*" %i IN ('minikube -p knativecookbook docker-env') DO @%i

=== Knative Installation
. Install Serving and Eventing CRDs
.. kubectl apply --selector knative.dev/crd-install=true --filename "https://github.com/knative/serving/releases/download/v0.18.0/serving.yaml"
.. kubectl apply --selector knative.dev/crd-install=true --filename "https://github.com/knative/eventing/releases/download/v0.18.0/eventing.yaml"
. Install Serving Components
.. kubectl apply --selector networking.knative.dev/certificate-provider!=cert-manager --filename "https://github.com/knative/serving/releases/download/v0.18.0/serving.yaml"
.. watch kubectl get pods -n knative-serving
. Install Eventing Components
.. kubectl apply --selector networking.knative.dev/certificate-provider!=cert-manager --filename "https://github.com/knative/eventing/releases/download/v0.18.0/eventing.yaml"
.. watch kubectl get pods -n knative-eventing

=== Verify Setup
. Verify minikube container registry is installed
.. kubectl get pods -n kube-system
... registry and registry-proxy pods should be running
. Verify DNS hacks
.. minikube ssh -- sudo cat /etc/hosts
... dev.local and example.com entries should exist
.. kubectl get svc registry -n kube-system
... hosts ip addresses should match the cluster ip
.. kubectl get cm -n kube-system coredns -o yaml
... dev.local and example.com should rewrite to the minikube registry
. Verify Istio installation
.. Verify Istio pods are running
... kubectl get pods -n istio-system
.... 
... kubectl get svc istio-ingressgateway -n istio-system
.... if EXTERNAL-IP is <none> or <pending> then use the service's node port to access the gateway 
..... host="minikube ip"
..... port="kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}'")
.... for more detail, see https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/)
.. kubectl api-resources --api-group=networking.istio.io
.. kubectl api-resources --api-group=config.istio.io
.. kubectl api-resources --api-group=authentication.istio.io
.. kubectl api-resources --api-group=rbac.istio.io
. Verify Knative installation
.. Verify Serving and Eventing CRDs
... kubectl api-resources --api-group=serving.knative.dev
... kubectl api-resources --api-group=messaging.knative.dev
... kubectl api-resources --api-group=eventing.knative.dev
... kubectl api-resources --api-group=sources.eventing.knative.dev
... kubectl api-resources --api-group=sources.knative.dev
.. Verify Serving and Eventing Components
... watch kubectl get pods -n knative-serving
... watch kubectl get pods -n knative-eventing

. Verify docker configuration
.. docker images --format {{.Repository}}
... this should list all images managed by k8s, not just the k8s image that docker is aware of.
